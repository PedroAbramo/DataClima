<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataClima - Monitoramento de Temperatura e Umidade em Data Centers</title>
    <link rel="stylesheet" href="Estilos/dashboard3.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap');
    </style>
    <script src="./script/dashboard.js"></script>
</head>

<body onload="validarSessao()">
    <nav class="side-nav">
        <div class="logo">
            <a href="index.html">
                <img src="images/DataClima_Logo.png" class="logo" style="width: 250px;">
            </a>
        </div>
        <ul class="navbar">
            <li class="usuario"><span id="b_usuario">Admin</span></li>
            <li class="usuario"><span id="b_datacenter">DataCenter Teste</span></li>
            <a href="PainelGeral2.html">
                <li class="item-menu">Visão Geral</li>
            </a>
            <a href="PainelEspecifico3.html">
                <li class="item-menu ativo">Painel Específico</li>
            </a>
            <a href="PainelRelatorio4.html">
                <li class="item-menu">Painel Relatório</li>
            </a>
            <p>Selecione a Sala:</p>
            <select id="salaselect" name="Sala" onchange="sala()"></select>

        </ul>
        <a href="https://sptech-team-wy40ngo8.atlassian.net/servicedesk/customer/portals" target="_blank"
            class="item-menu sair Suporte">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                <path
                    d="m12,2C6.49,2,2,6.49,2,12v5c0,.55.45,1,1,1h3c.55,0,1-.45,1-1v-5c0-.55-.45-1-1-1h-1.93c.49-3.94,3.86-7,7.93-7s7.44,3.06,7.93,7h-1.93c-.55,0-1,.45-1,1v5c0,.55.45,1,1,1h2v1c0,.55-.45,1-1,1h-4c0-.55-.45-1-1-1h-4c-.55,0-1,.45-1,1v1c0,.55.45,1,1,1h9c1.65,0,3-1.35,3-3v-7c0-5.51-4.49-10-10-10Z">
                </path>
            </svg>
            Suporte
        </a>
        <a href="login.html" class="item-menu sair">
            <div>
                Sair
            </div>
        </a>
    </nav>

    <div class="tela">
        <div class="titulo">
            <h1 id="titulo"></h1>
        </div>
        <div class="info">

            <!-- Temperatura -->
            <div id="div_sensor"></div>
            <div class="temperatura">
                <div class="dados-indiv">
                    <div class="valores">
                        <p>Temperatura Máxima</p>
                        <strong id="temp-max"> <span id="valorTempMax">0°C</span></strong>
                    </div>
                    <div class="valores">
                        <p>Temperatura Mínima</p>
                        <strong id="temp-min"> <span id="valorTempMin">0°C</span></strong>
                    </div>
                    <div class="ultima-att">
                        <p>Ultima atualização:</p>
                        <div class="div_dataHora"><span class="DataHora_select">dd/mm/yyyy - hh:mm</span></div>
                    </div>

                </div>
                <div class="dashboard">
                    <canvas id="sensorTemperatura"></canvas>
                </div>
                <div class="legenda">
                    <p><span style="color: #14EE00;">■</span> <b>Temperatura Normal</b> <br>Entre 18°C e 27°C</p>
                    <br>
                    <p><span style="color: #E6E600;">■</span> <b>Temperatura Em Alerta</b> <br>Abaixo de 18°C ou Acima
                        de 27°C </p>
                    <br>
                    <p><span style="color: #bc6363;">■</span> <b>Temperatura Crítica</b> <br>Acima de 32°C</p>
                </div>
            </div>

            <!-- Umidade -->
            <div class="umidade">
                <div class="dados-indiv">
                    <div class="valores">
                        <p>Umidade Máxima</p>
                        <strong id="umidade-max" ><span id="valorHumiMax">0%</span></strong>
                    </div>
                    <div class="valores">
                        <p>Umidade Mínima</p>
                        <strong id="umidade-min" ><span id="valorHumiMin">0%</span></strong>
                    </div>
                    <div class="ultima-att">
                        <p>Ultima atualização:</p>
                        <div class="div_dataHora"><span class="DataHora_select">dd/mm/yyyy - hh:mm</span></div>
                    </div>

                </div>

                <div class="dashboard">
                    <canvas id="sensorUmidade"></canvas>
                </div>
                <div class="legenda">
                    <p><span style="color: #14EE00;">■</span> <b>Umidade Normal</b> <br>Entre 40% e 55%</p>
                    <br>
                    <p><span style="color: #E6E600;">■</span> <b>Umidade Em Alerta</b> <br>Abaixo de 40% ou acima de 55%
                    </p>
                    <br>
                    <p><span style="color: #bc6363;">■</span> <b>Umidade Crítica</b> <br>Menor que 20%</p>
                </div>
            </div>

            <script>

                let idSala = sessionStorage.SALA
                console.log(idSala);
                titulo.innerHTML = sessionStorage.NOME_SALA;
                const datacenters = JSON.parse(sessionStorage.DATACENTERS)

                for (let i = 0; i < datacenters.length; i++) {
                    if (datacenters[i].id == sessionStorage.ID_DATACENTER) {
                        b_datacenter.innerHTML = datacenters[i].datacenter
                        break
                    }
                }

                var dadosSensor = []
                var horaLabel = []
                var temp = [];
                var umi = [];
                var sensorTemperatura;
                var sensorUmidade;
                var registroHora = [];

                function buscarRegistrosPeriodicamente() {

                    console.log("Buscando os registros")

                    fetch(`/datacenter/registros/${sessionStorage.SALA}`, {
                        method: "GET",
                    })
                        .then(function (resposta) {
                            if (resposta.ok) {
                                resposta.json()
                                    .then((dados) => {
                                        dadosSensor = dados;

                                        temp = [];
                                        umi = [];
                                        registroHora = []

                                        dadosSensor.forEach(dados => {
                                            temp.push(dados.temperatura);
                                        })

                                        dadosSensor.forEach(dados2 => {
                                            umi.push(dados2.umidade);
                                        })

                                        dadosSensor.forEach(registro => {
                                            let data = registro.dataRegistro;
                                            let valor1 = data.split('T')[0];
                                            let [ano, mes, dia] = valor1.split('-');
                                            let valor2 = data.split('T')[1];
                                            let valor3 = valor2.split('.')[0];
                                            let [hora, minuto, segundo] = valor3.split(':');

                                            hora = parseInt(hora);
                                            dia = parseInt(dia);

                                            if (hora < 3) {
                                                hora += 24
                                                dia -= 1
                                            }

                                            registroHora.push(`${hora - 3}:${minuto}:${segundo}`)
                                        })

                                        console.log("Hora do registro:", registroHora);
                                        console.log("Dados do Sensor:", dadosSensor);

                                        criarOuAtualizarGrafico()
                                    });
                            }
                        })
                }

                function criarOuAtualizarGrafico() {
                    let canvasTemperatura = document.getElementById('sensorTemperatura');
                    let canvasUmidade = document.getElementById('sensorUmidade');

                    if (!sensorTemperatura) {
                        sensorTemperatura = new Chart(canvasTemperatura, {
                            type: 'line',
                            data: {
                                labels: registroHora,
                                datasets: [{
                                    label: 'Temperatura',
                                    borderColor: '#004080',
                                    backgroundColor: '#66B2FF',
                                    data: temp
                                }]
                            },
                            options: {
                                scales: {
                                    x: {
                                        reverse: true,
                                        beginAtZero: true,
                                        ticks: {
                                            maxRotation: 45,
                                            minRotation: 45
                                        },
                                    },
                                    y: {
                                        title: {
                                            display: true,
                                            text: '(°C)'
                                        },
                                        beginAtZero: true,
                                    }
                                }
                            }
                        });
                    } else {
                        sensorTemperatura.data.labels = registroHora;
                        sensorTemperatura.data.datasets[0].data = temp;
                        sensorTemperatura.update();
                    }

                    if (!sensorUmidade) {
                        sensorUmidade = new Chart(canvasUmidade, {
                            type: 'line',
                            data: {
                                labels: registroHora,
                                datasets: [{
                                    label: 'Umidade',
                                    borderColor: '#87CEEB',
                                    backgroundColor: '#0056b3',
                                    data: umi,
                                }]
                            },
                            options: {
                                scales: {
                                    x: {
                                        reverse: true,
                                        beginAtZero: true,
                                        ticks: {
                                            maxRotation: 45,
                                            minRotation: 45
                                        },
                                    },
                                    y: {
                                        title: {
                                            display: true,
                                            text: '(%)'
                                        },
                                        beginAtZero: true,
                                    },
                                },
                            }
                        });
                    } else {
                        sensorUmidade.data.labels = registroHora;
                        sensorUmidade.data.datasets[0].data = umi;
                        sensorUmidade.update();
                    }
                }


                window.onload = function () {
                    buscarRegistrosPeriodicamente();
                    ultimaAtualizacao();
                    listarSalas();
                    

                    setInterval(function () {
                        buscarRegistrosPeriodicamente();
                        TemperaturaUmidadeMAXMIN(idSala);
                    }, 1000)

                    setInterval(function () {
                        ultimaAtualizacao();
                    }, 5000)
                }
            </script>
</body>

</html>

<script>
    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;
</script>